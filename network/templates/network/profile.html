{% extends 'network/layout.html' %}
{% load static %}

{% block body %}

    <section id="profile-page">

        <div id="profile">
            <h2>{{ username }}</h2>
            {% if user.is_authenticated %}
                {% if username != current_user %}
                <form action="{% url 'follow' username %}" id="follow-form" method="POST">
                    {% csrf_token %}
                    {% if is_followed %}
                        <button id="follow-button" class="unfollow">Unfollow</button>
                    {% else %}
                        <button id="follow-button" class="follow">Follow</button>
                    {% endif %}
                </form>
                {% endif %}
            {% endif %}
            <p>{{ bio }}</p>
            <div id="profile-details">
                <p>Followers: {{ follower_count }}</p>
                <p>Following: {{ following_count }}</p>
            </div>
        </div>

        <div id="profile-content">
            <div id="posts-container">
                <div id="post-list">
                </div>
            </div>
        </div>

        
        
    </section>

    <div id="loading-text"></div>
    

    <script>

        let currentPage = 1;
        const postsPerPage = 10;
        let loadMorePosts = false;
        let allPostsLoaded = false;
    
        function fetchUserPosts(username, page) {
            if (loadMorePosts || allPostsLoaded) {
                return;
            }
            loadMorePosts = true;
            const loadingText = document.getElementById('loading-text');
            loadingText.textContent = 'Loading...';
    
            fetch(`/get_user_posts/${username}?page=${page}`)
                .then(response => response.json())
                .then(data => {
                    const postList = document.getElementById('post-list');
    
                    data.posts.forEach(post => {
                        const postItem = document.createElement('div');
                        postItem.className = 'post-item';
                        postItem.innerHTML = `
                            <p class="post-author"><strong>${post.author}</strong></p>
                            <p>${post.text}</p>
                            <p>${post.timestamp}</p>
                            <div class="likes-comments">
                                <p>Liked by: ${post.liked_by.join(', ')}</p>
                                <p>Comments: ${post.comments.length}</p>
                            </div>
                        `;
                        postList.appendChild(postItem);
                    });
    
                    currentPage++;
                    loadMorePosts = false;
    
                    if (data.posts.length < postsPerPage) {
                        allPostsLoaded = true;
                        loadingText.textContent = 'No more posts to load';
                    } else {
                        loadingText.textContent = '';
                    }
                })
                .catch(error => {
                    console.error('Error fetching posts:', error);
                    loadMorePosts = false;
                    loadingText.textContent = '';
                });
        }
    
        let timeout;
        window.addEventListener('scroll', function () {
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight) {
                clearTimeout(timeout);
                timeout = setTimeout(function () {
                    fetchUserPosts(username, currentPage);
                }, 1000);
            }
        });
    
        const username = "{{ username }}";
        fetchUserPosts(username, currentPage);
    </script>

{% endblock  %}